# 다양한 입출력 방법

### 세 가지 입출력 방식

1. 프로그램 입출력 
2. 인터럽트 기반 입출력 
3. DMA 입출력 

### 프로그램 입출력

입출력 장치에 연결된 **장치 컨트롤러를 프로그램 속 명령어로 제어**하는 방법 

- CPU가 장치 컨트롤러의 레지스터의 값을 읽고 씀으로써 이루어진다.

예시 

메모리에 저장된 정보를 하드디스크에 백업

⇒ 하드디스크에 새로운 정보 쓰기

1. CPU → 하드디스크 컨트롤러의 제어 레지스터에 → 쓰기 명령어  내보냄 제어 레지스터에 입출력 장치가 수행할 동작을 저장
2. 하드 디스크 컨트롤러 → 하드 디스크 상태 확인 → 하드디스크 컨트롤러는 상태 레지스터에 준비 되었다고 알림 → 상태 레지스터 준비 완료 
3. CPU는 상태 레지스터를 주기적으로 확인 하드 디스크의 준비 완료 여부 확인 
4. 하드 디스크 준비 완료 시 백업할 메모리의 정보를 데이터 레지스터에 쓴다 
5. 쓰기가 끝나면 종료 

CPU 장치 컨트롤러의 레지스터 값을 어떻게 알까? 

프로그램 입출력 방식인 메모리 맵 입출력, 고립형 입출력으로 알 수 있다. 

### 프로그램 입출력 - 메모리 맵 입출력

- 메모리에 접근하기 위한 주소 공간과 입출력장치에 접근하기 위한 주소 공간을 하나의 주소 공간으로 간주하는 방법

  ![Untitled (4)](https://user-images.githubusercontent.com/79884004/230916745-9e85aa30-bd31-43c4-87cd-0b3b4844ebe2.png)
    
- 메모리 접근 명령어 == 입출력 장치 접근 명령어
- 메모리와 입출력장치는 같은 주소 공간 사용
- 메모리 주소 공간이 축소(제한)
- 메모리와 입출력장치에 같은 명령어 사용 가능

### 프로그램 입출력  - 고립형 입출력

- 메모리를 위한 주소 공간과 입출력 장치를 위한 주소 공간을 분리하는 방법
- (입출력 읽기/쓰기 선 활성화) 입출력 전용 명령어 사용

<img width="500" alt="스크린샷 2023-04-10 오후 7 16 52" src="https://user-images.githubusercontent.com/79884004/230916756-17bf0df1-5a45-41e3-8bfc-e9077a71e2f0.png">



- 메모리와 입출력장치는 분리된 주소 공간 사용
- 메모리 주소 공간이 축소되지 않음
- 입출력 전용 명령어 사용

### 입터럽트 기반 입출력

인터럽트 복습하자!!  [11. 명령어 사이클과 인터럽트](https://github.com/HYO00/TIL/blob/main/%EC%BB%B4%ED%93%A8%ED%84%B0%20%EA%B3%B5%ED%95%99%20%EC%A7%80%EC%8B%9D/11.%20%EB%AA%85%EB%A0%B9%EC%96%B4%20%EC%82%AC%EC%9D%B4%ED%81%B4%EA%B3%BC%20%EC%9D%B8%ED%84%B0%EB%9F%BD%ED%8A%B8.md)

- (하드웨어) 인터럽트의 개념 
입출력 장치가 일을 할 동안 다른 일을 할 수 있게 하는 알람 같은 개념
- 플래그 레지스터 속 인터럽트 비트
활성화 비활성화 → 인터럽트를 받아들일지 안받아들일지
- 인터럽트 요청 신호 
CPU한테 입출력 장치가 요청신호로 끼어들어도 되니 요청하는 신호
- 인터럽트 서비스 루틴
인터럽트를 처리하기 위한 특별한 프로그램

하드웨어 인터럽트는 **장치 컨트롤러에 의해 발생** 

CPU - 입출력 명령(프린트 해 줘) → 장치 컨트롤러 - 프린터기

CPU ← **인터럽트 요청 (다 했어)- 장치 컨트롤러** - 프린터기

동시다발적인 인터럽트: 입출력장치가 많을 때 ?

1. 인터럽트 발생 순서대로 처리 . 
플래그 레지스터 속 인터럽트 비트를 비 활성화한 채 인터럽트를 처리하는 경우
* 하드웨어 고장 정전 발생 중요도가 높은 인터럽트 발생 시 인터럽트 비트 비활성화해도 처리 된다. 
    
    *현실적으로 순차적으로 처리 할 수 없고 인터럽트 중에서 우선 순위가 높은 인터럽트를 처리해야 한다. 
    
2. 우선순위를 반영한 인터럽트 
우선순위 높은 인터럽트 발생 시 현재 실행 중인 인터럽트 서비스 루틴은 중단하고 우선순위가 높은 인터럽트 서비스 루틴을 실행한다. 
- PIC(Programmable Interrupt Controller) ?

<img width="348" alt="스크린샷 2023-04-10 오후 7 00 06" src="https://user-images.githubusercontent.com/79884004/230916788-e5989a8f-9d06-4162-81de-a3d38ee8edd3.png">

위 사진 핀처럼 생긴 모양에 각 입출려장치들이 연결

여러 장치 컨트롤러에 연결되어 장치 컨트롤러의 하드웨어 인터럽트의 우선순위를 판단한 뒤 CPU에게 지금 처리해야 하는 인터럽트를 판단하고 알려주는 하드웨어이다.

<img width="500" alt="스크린샷 2023-04-10 오후 7 04 00" src="https://user-images.githubusercontent.com/79884004/230916806-285f010b-00d8-4814-bc62-e02e91bbc246.png">

### DMA 입출력

프로그램 입출력, 인터럽트 기반 입출력의 공통점이 뭘까

입출력장치와 메모리 간의 데이터 이동 → CPU가 주도

이동하는 데이터도 반드시 CPU를 거친다. 

EX.

하드디스크 데이터를 메모리에 저장 할 때

1. 하드디스크 데이터 레지스터에 저장되어 있는 값을 임출력 장치가 읽어들여 CPU의 레지스터로 읽어들이고
2. CPU의 레지스터를 쓰기 명령어를 통해 메모리에 쓴다

저당된 값을 하드디스크에 저장 할 때

1. CPU는 데이터를 메모리로부터 읽어들인다.
2. 읽어드린 값을 장치 컨트롤러의 레지스터로 쓰게 된다.

CPU 바쁜데..! 

하드 디스크 백업과 같은 대용량 데이터 이동해야하는 입출력 작업이 있으면?

CPU는 부담스럽다

**DMA (Direct Memory Access)**

CPU를 거치지 않고 입출력장치가 **메모리에 직접적으로 접근** 하는 기능 (훌륭하네)

<img width="500" alt="스크린샷 2023-04-10 오후 7 16 52" src="https://user-images.githubusercontent.com/79884004/230917924-be25074b-8aaa-4d2e-9e5c-026854131ab6.png">


**DMA 입출력 과정** 

1. CPU는 DMA 컨트롤러에 입출력 작업을 명령
(하드디스크에 메모리 정보 백업하는 입출력 작업 부탁한다!!)
2. **DMA 컨트롤러는 CPU 대신 장치 컨트롤러와 상호작용하며 입출력 작업을 수행** 
    
    (메모리 → DMA 컨트롤러 → 장치 컨트롤러)
    (CPU는 다른 작업 해)
    
3. 입출력 작업 끝 → DMA 컨트롤러 인터럽트를 통해 → CPU에게 작업 끝남을 알림

메모리와 장치컨트롤러 사이에 주고받는 데이터는 CPU를 거치지 않게 된다.
CPU는 입출력 작업의 시작과 끝만 관여하면 된다.

문제발생 !

DMA 과정에서 시스템 버스를 이용 → 시스템 버스는 공용자원이라 동시에 사용불가 

⇒ CPU가 시스템 버스 사용할 때 DMA 컨트롤러는 시스템 버스 사용 못함 반대의 경우도 마찬가지

그렇다면 어떻게 해야할까?

1. CPU가 시스템 버스를 이용하지 않을 때마다 조금씩 시스템 버스 이용
2. CPU한테 잠시 사용하지 말라고 양해 구하고 DMA가 이용
* 이런 모습 Cycle strealing이라고 불림 스틸..

### 입출력 버스

장치 컨트롤러가 시스템 버스에 직접 연결되어도 괜찮나?

직접연결 되면 DMA 과정에서 불필요하게 시스템 버스를 두번 이용하게 된다?

메모리에 있는 정보를 하드디스크에 백업 입출력 작업 → 메모리를 읽어들이기 위해 1번 장치 컨트롤러에 쓰기 위해 1번 이렇게 2번 이용하게 된다. 

**입출력 버스**를 통해 시스템 버스 이용 빈도를 낮춘다.

<img width="500" alt="스크린샷 2023-04-10 오후 7 37 58" src="https://user-images.githubusercontent.com/79884004/230916851-760b84ad-9da7-4f8b-a4ab-1f8cc82b4b60.png">

PCI 버스, PCI express (PCIe) 버스와 입출력 장치를 연결짓는 슬롯 

슬롯 →  입출력 버스 → 시스템버스 

발전한 DMA ⇒ 입출력 프로세서  (입출력작업 명령어를 실행하는거까지 실행)

앞으 공부할 운영체제도 파이팅!!
